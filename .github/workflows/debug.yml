name: Debug BTV API

on:
  workflow_dispatch:  # ম্যানুয়ালি রান করার জন্য
  push:
    paths:
      - '.github/workflows/debug.yml'

jobs:
  debug-api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # v3 to v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Run Debug Commands
        run: |
          echo "========================================="
          echo "BTV Channel API Debugger"
          echo "========================================="
          echo ""
          
          # Test main API
          echo "1. Testing Main API:"
          echo "----------------------------------------"
          MAIN_API="https://www.btvlive.gov.bd/api/home"
          echo "URL: $MAIN_API"
          
          MAIN_RESPONSE=$(curl -s -w "\n%{http_code}" "$MAIN_API" -A "Mozilla/5.0" -m 10 --insecure)
          MAIN_HTTP_CODE=$(echo "$MAIN_RESPONSE" | tail -n1)
          MAIN_BODY=$(echo "$MAIN_RESPONSE" | sed '$d')
          
          echo "HTTP Status: $MAIN_HTTP_CODE"
          echo "Response Size: ${#MAIN_BODY} characters"
          
          if [ "$MAIN_HTTP_CODE" = "200" ]; then
              echo "✓ Main API is accessible"
              
              # Check if it's JSON
              if echo "$MAIN_BODY" | jq empty 2>/dev/null; then
                  echo "✓ Valid JSON response"
                  echo "Root keys: $(echo "$MAIN_BODY" | jq 'keys')"
              else
                  echo "✗ Not a valid JSON response"
                  echo "First 200 chars:"
                  echo "$MAIN_BODY" | head -c 200
              fi
          else
              echo "✗ Main API failed"
          fi
          
          echo ""
          echo "2. Testing Individual Channel APIs:"
          echo "----------------------------------------"
          
          # Test each channel
          CHANNELS=("BTV" "BTV-News" "BTV-Chattogram" "Sangsad-Television")
          
          for channel in "${CHANNELS[@]}"; do
              echo ""
              echo "Channel: $channel"
              echo "------------------------"
              
              # Try with the build ID from your original script
              BUILD_ID="wr5BMimBGS-yN5Rc2tmam"
              API_URL="https://www.btvlive.gov.bd/_next/data/${BUILD_ID}/channel/${channel}.json?id=${channel}"
              echo "  URL: $API_URL"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL" -A "Mozilla/5.0" -m 10 --insecure)
              HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              echo "  HTTP Status: $HTTP_CODE"
              
              if [ "$HTTP_CODE" = "200" ]; then
                  echo "  ✓ Success!"
                  
                  # Try to extract data
                  echo "  Looking for identifier..."
                  IDENTIFIER=$(echo "$BODY" | jq -r '.pageProps.currentChannel.channel_details.identifier // "not found"' 2>/dev/null)
                  echo "  Identifier: $IDENTIFIER"
                  
                  echo "  Looking for banner..."
                  BANNER=$(echo "$BODY" | jq -r '.pageProps.currentChannel.channel_details.banner // "not found"' 2>/dev/null)
                  echo "  Banner: $BANNER"
                  
                  echo "  Looking for sourceURL..."
                  SOURCE_URL=$(echo "$BODY" | jq -r '.pageProps.sourceURL // "not found"' 2>/dev/null)
                  echo "  SourceURL: $SOURCE_URL"
                  
                  if [ "$SOURCE_URL" != "not found" ]; then
                      USER_ID=$(echo "$SOURCE_URL" | grep -oP '[^/]+(?=/index\.m3u8)' | tail -1)
                      echo "  Extracted User ID: $USER_ID"
                  fi
                  
                  # Show full response structure (limited)
                  echo ""
                  echo "  Response structure (first level keys):"
                  echo "$BODY" | jq 'keys' 2>/dev/null
              else
                  echo "  ✗ Failed with HTTP $HTTP_CODE"
              fi
              echo "------------------------"
          done
          
          echo ""
          echo "3. Testing with Browser Headers:"
          echo "----------------------------------------"
          
          CHANNEL="BTV"
          BUILD_ID="wr5BMimBGS-yN5Rc2tmam"
          API_URL="https://www.btvlive.gov.bd/_next/data/${BUILD_ID}/channel/${CHANNEL}.json?id=${CHANNEL}"
          
          echo "Testing with full browser headers:"
          FULL_RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL" \
              -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              -H "Accept: application/json, text/plain, */*" \
              -H "Accept-Language: en-US,en;q=0.9" \
              -H "Referer: https://www.btvlive.gov.bd/" \
              -H "Origin: https://www.btvlive.gov.bd" \
              -H "Connection: keep-alive" \
              --insecure -m 10)
          
          FULL_HTTP_CODE=$(echo "$FULL_RESPONSE" | tail -n1)
          FULL_BODY=$(echo "$FULL_RESPONSE" | sed '$d')
          
          echo "HTTP Status: $FULL_HTTP_CODE"
          if [ "$FULL_HTTP_CODE" = "200" ]; then
              echo "✓ Headers working!"
              echo "Response keys: $(echo "$FULL_BODY" | jq 'keys' 2>/dev/null)"
              
              # Try to extract data
              IDENTIFIER=$(echo "$FULL_BODY" | jq -r '.pageProps.currentChannel.channel_details.identifier // "not found"' 2>/dev/null)
              echo "Identifier with headers: $IDENTIFIER"
          else
              echo "✗ Headers didn't help"
          fi
          
          echo ""
          echo "========================================="
          echo "Debug Complete"
          echo "========================================="

      - name: Save Debug Output
        if: always()
        run: |
          {
            echo "=== Debug Output ==="
            echo "Timestamp: $(date)"
            echo ""
            echo "1. Main API Test:"
            curl -I "https://www.btvlive.gov.bd/api/home" -m 5 2>/dev/null || echo "Failed"
            echo ""
            echo "2. Channel API Tests:"
            for channel in BTV BTV-News BTV-Chattogram Sangsad-Television; do
              echo ""
              echo "--- $channel ---"
              curl -s "https://www.btvlive.gov.bd/_next/data/wr5BMimBGS-yN5Rc2tmam/channel/${channel}.json?id=${channel}" \
                -H "User-Agent: Mozilla/5.0" \
                -m 5 | jq '.' 2>/dev/null || echo "Failed to fetch"
            done
          } > debug_output.txt

      - name: Upload Debug Output
        if: always()
        uses: actions/upload-artifact@v4  # v3 to v4
        with:
          name: debug-output
          path: debug_output.txt
